# transcoder

Данный проект является составляющей другого проекта и находится в стадии разработки, но его можно модифицировать в самостоятельный, если изменить сервис TranscodeService или ReturnConpiteService

Описание:
Сервер ожидает на свой эндпоит массив из данных, среди которых есть имя директории с фильмом и имя директории куда будет сложан нарезанный hls.
Транскодирование происходит воркером в фоне, с использованием ffmpeg.
Эндпоинт описан с помощью swagger и доступен по пути /api

Стэк:
PHP 8.2, Symfony 7.*, ffmpeg, Api Platform, Redis

В результате транскодирования получится следующая структура:
<Директория с именем фильма>
    |
    |->1080p
    |    |
    |    |->1080p_000.ts
    |    |
    |    |->1080p_001.ts
    |    ...
    |    |->1080p.m3u8
    |
    |->720p
    |    |
    |    |->720p_000.ts
    |    |
    |    |->720p_001.ts
    |    ...
    |    |->720p.m3u8
    |
    |->playlist.m3u8

Важные примичание:
Команда ffmpeg по умолчанию, использует cuda драйвер для видео карт nvidia. Необходимо скомпилировать ffmpeg с поддержкой этого драйвера, если у вас другая видеокарта или вы планируете использовать процессор, тогда обязательно измените шаблон команды.
Так же необходимо что бы, он был доступен как переменная окружения.
Подразумевается что, ваш VOD содержит несколько дисков и они имеют одинаковую структуру:
/HDD/1/VOD/content/Season
/HDD/1/VOD/content/Movie
/HDD/5/VOD/content/Season
/HDD/5/VOD/content/Movie
...

Так же важно отметить что, фильмы и сериалы разбиты на разные директории. Это сделано с целью упрощения навигации при большом обьеме контента.
Если транскодер и VOD являются разными машинами, нужно примонтировать диски VOD сервера, согласно описаной структуре.

Настройка:
Все ключевые параметры описаны в .env файле
SUPPORTED_EXTENSIONS - Поддерживаемые форматы (сейчас перечислены только те, которые тестировались). Указывается в виде текстового массива
INPUT_DIR - Корневая директория с директориями в которых лежат фильмы
TARGET_DIR - Целевая директория в которой будут создаваться директории с нарезанным hls
TRANSCODE_DEBUG - Включение и отключение дебаг режима. В дебаг режиме транскодирование производится только в 360p
MASTER_PLAYLIST - Имя мастер плейлиста, по умолчанию playlist.m3u8 как в примере выше
CONTENT_MAKER_ADDR - Адрес мейкер сервера для создания записей в smarty. указывается в формате http://127.0.0.1:8000

Так как транскодирование выполняют воркеры, можно запустить их командой:
symfony console messenger:consume transcoding

Не рекомендуется запускать больше одного воркера. Это есть в планах, но еще не тестировалось.

Шаблоны команд можно задать в src/Service/FfmepgHandler/CommandMakerService.php (В  дальнейшем будет вынесено в хранилище)

Пример отправки задачи на транскодирование с помощью curl запроса:
curl -X 'POST' \
  'https://example.com/api/create/task' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "kinopoiskId": "401152",
  "title": "Avatar_Aang_serial",
  "isSerial": false,
  "isTrailler": false,
  "seasonCount": "",
  "sameEpisodesCount": false,
  "sameEpisodes": [],
  "episodesCount": [],
  "uploadToSmarty": "no",
  "transcode": true,
  "fileName": "Avatar_1080p_by_krosh",
  "handhdd": false,
  "selectedDisk": 20,
  "user": "k9lis"
  }'

  Логирование:
  Идет сбор логов об успехе транскодирования, вывод ffmpeg, и ошибки (в ошики сейчас валится вывод ffmpeg будет пофикшено в будущем).